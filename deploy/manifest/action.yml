name: Deploy manifests to Kubernetes
description: "Build application images"
inputs:
  image:
    description: "Image to deploy"
    required: true
  mainbranch:
    description: "Main branch"
    required: true
  statebranch:
    description: "State branch"
    required: true
  prmessage:
    description: "PR message"
    default: "Created by Github action"
    required: false
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ inputs.statebranch }}

    - name: Create new temp branch
      shell: pwsh
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git checkout -b "temp-${{ github.run_id }}"
        git branch --set-upstream-to=origin/temp-${{ github.run_id }} temp-${{ github.run_id }}
        git fetch --unshallow
        git pull
        git merge --no-ff ${{ inputs.mainbranch }}

    - name: Update state
      shell: pwsh
      run: |
        # Lets replace all the variables in the state file
        # update the image version
        $Manifests = Get-ChildItem -Path ${{ env.APP_AUTO_WORKING_PATH }}/gitops/scaling -Filter *.yaml,*.yml -Recurse
        foreach($Manifest in $Manifests)
        {
          $ManifestContent = Get-Content -Path $Manifest.FullName
          $ManifestContent = $ManifestContent -replace "{{IMAGE}}", ${{ inputs.image }}
          $ManifestContent | Set-Content -Path $Manifest.FullName
        }
    - name: Commit and pr to state
      shell: pwsh
      run: |
        git add ${{ env.APP_AUTO_WORKING_PATH }}/gitops/scaling/*
        git commit -m "Updated state"
        gh pr create -B "temp-${{ github.run_id }}" -H ${{ inputs.statebranch }} --title "Merge "temp-${{ github.run_id }}" into ${{ inputs.statebranch }}" --body "${{ inputs.prmessage }}"
      env:
        GITHUB_TOKEN: ${{ github.token }}
